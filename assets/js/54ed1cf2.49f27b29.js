"use strict";(self.webpackChunkmiddy=self.webpackChunkmiddy||[]).push([[2947],{4941:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"best-practices/profiling","title":"Profiling","description":"Inside of @middy/core we\'ve added some hook before and after every middleware called, the handler and from start to end of it\'s execution.","source":"@site/docs/best-practices/07-profiling.md","sourceDirName":"best-practices","slug":"/best-practices/profiling","permalink":"/docs/best-practices/profiling","draft":false,"unlisted":false,"editUrl":"https://github.com/middyjs/middy/tree/main/website/docs/best-practices/07-profiling.md","tags":[],"version":"current","lastUpdatedAt":1750110598000,"sidebarPosition":7,"frontMatter":{"title":"Profiling","sidebar_position":7},"sidebar":"tutorialSidebar","previous":{"title":"Small node_modules","permalink":"/docs/best-practices/small-node-modules"},"next":{"title":"FAQ","permalink":"/docs/faq"}}');var o=n(4848),s=n(8453);const i={title:"Profiling",sidebar_position:7},a=void 0,d={},l=[{value:"Time",id:"time",level:2},{value:"Memory",id:"memory",level:2}];function c(e){const t={code:"code",h2:"h2",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(t.p,{children:["Inside of ",(0,o.jsx)(t.code,{children:"@middy/core"})," we've added some hook before and after every middleware called, the handler and from start to end of it's execution."]}),"\n",(0,o.jsx)(t.h2,{id:"time",children:"Time"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-javascript",children:"\nconst defaults = {\n  logger: console.log,\n  enabled: true\n}\n\nconst timePlugin = (opts = {}) => {\n  const { logger, enabled } = { ...defaults, ...opts }\n  const store = {}\n\n  const start = (id) => {\n    store[id] = process.hrtime.bigint()\n  }\n  const stop = (id) => {\n    if (!enabled) return\n    logger(id, Number.parseInt((process.hrtime.bigint() - store[id]).toString()) / 1000000, 'ms')\n  }\n\n  // Only run during cold start\n  const beforePrefetch = () => start('total')\n  const requestStart = () => {\n    if (!store.init) {\n      store.init = store.total\n      stop('init')\n    } else {\n      start('total')\n    }\n  }\n  const beforeMiddleware = start\n  const afterMiddleware = stop\n  const beforeHandler = () => start('handler')\n  const afterHandler = () => stop('handler')\n  const requestEnd = () => stop('total')\n\n  return {\n    beforePrefetch,\n    requestStart,\n    beforeMiddleware,\n    afterMiddleware,\n    beforeHandler,\n    afterHandler,\n    requestEnd\n  }\n}\n\nexport const handler = middy(timePlugin())\n  .use(eventLogger())\n  .use(errorLogger())\n  .use(httpEventNormalizer())\n  .use(httpHeaderNormalizer())\n  .use(httpUrlencodePathParametersParser())\n  .use(httpUrlencodeBodyParser())\n  .use(httpJsonBodyParser())\n  .use(httpCors())\n  .use(httpSecurityHeaders())\n  .use(validator({eventSchema}))\n  .handler(()=>{})\n  \nawait handler()\n"})}),"\n",(0,o.jsx)(t.p,{children:"This will log out something this:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-shell",children:"inputOutputLoggerMiddlewareBefore 0.156033 ms\nhttpEventNormalizerMiddlewareBefore 0.073921 ms\nhttpHeaderNormalizerMiddlewareBefore 0.095098 ms\nhttpUrlencodePathParserMiddlewareBefore 0.036255 ms\nhttpUrlencodeBodyParserMiddlewareBefore 0.038809 ms\nhttpJsonBodyParserMiddlewareBefore 0.048383 ms\nhttpContentNegotiationMiddlewareBefore 0.042311 ms\nvalidatorMiddlewareBefore 0.083366 ms\nhandler 0.094875 ms\nvalidatorMiddlewareAfter 0.083601 ms\nhttpSecurityHeadersMiddlewareAfter 0.19702 ms\nhttpCorsMiddlewareAfter 0.080532 ms\ninputOutputLoggerMiddlewareAfter 0.066886 ms\nlambda 66.141835 ms\n"})}),"\n",(0,o.jsxs)(t.p,{children:["From this everything looks good. Sub 1ms for every middleware and the handler. But wait, that ",(0,o.jsx)(t.code,{children:"total"})," doesn't look right.\nYou're correct, ",(0,o.jsx)(t.code,{children:"total"})," includes the initial setup time (or cold start time) for all middlewares. In this case ",(0,o.jsx)(t.code,{children:"validator"})," is the culprit.\nThe Ajv constructor and compiler do a lot of magic when they first run to get ready for later schema validations.\nThis is why in the ",(0,o.jsx)(t.code,{children:"validator"})," middleware we now support passing in complied schema and expose the default compiler in\ncase you want to use it in a build step. We hope this feature will help to you in identify slow middlewares and improve your development experience."]}),"\n",(0,o.jsxs)(t.p,{children:["There is also a ",(0,o.jsx)(t.code,{children:"beforeRequest"})," hook, but was left out of the example for dramatic effect."]}),"\n",(0,o.jsx)(t.p,{children:"Additionally, you'll notice that each middleware shows a descriptive name. This is printing out the function name passed into middy core.\nIf you've looked at the code for some the supported middlewares, you'll see these long descriptive variable names being set, then returned.\nThis is why."}),"\n",(0,o.jsx)(t.h2,{id:"memory",children:"Memory"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-javascript",children:"import memwatch from '@airbnb/node-memwatch'\n\nconst defaults = {\n  logger: console.log\n}\n\nconst memoryPlugin = (opts = {}) => {\n  const { logger } = { ...defaults, ...opts }\n  const store = {}\n\n  const start = (id) => {\n    store[id] = new memwatch.HeapDiff()\n  }\n  const stop = (id) => {\n    logger(id, store[id].end())\n  }\n\n  const beforePrefetch = () => start('total')\n  const requestStart = () => {\n    store.init = store.total\n    stop('init')\n  }\n  const beforeMiddleware = start\n  const afterMiddleware = stop\n  const beforeHandler = () => start('handler')\n  const afterHandler = () => stop('handler')\n  const requestEnd = () => stop('total')\n\n  return {\n    beforePrefetch,\n    requestStart,\n    beforeMiddleware,\n    afterMiddleware,\n    beforeHandler,\n    afterHandler,\n    requestEnd\n  }\n}\n\nexport const handler = middy(memoryPlugin())\n  .use(eventLogger())\n  .use(errorLogger())\n  .use(httpEventNormalizer())\n  .use(httpHeaderNormalizer())\n  .use(httpUrlencodePathParametersParser())\n  .use(httpUrlencodeBodyParser())\n  .use(httpJsonBodyParser())\n  .use(httpCors())\n  .use(httpSecurityHeaders())\n  .use(validator({eventSchema}))\n  .handler(()=>{})\n  \nawait handler()\n"})})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>a});var r=n(6540);const o={},s=r.createContext(o);function i(e){const t=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),r.createElement(s.Provider,{value:t},e.children)}}}]);