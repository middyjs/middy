"use strict";(self.webpackChunkmiddy=self.webpackChunkmiddy||[]).push([[8927],{6884:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"upgrade/4-5","title":"Upgrade 4.x -> 5.x","description":"aka \\"The ESM Only Update\\"","source":"@site/docs/upgrade/4-5.md","sourceDirName":"upgrade","slug":"/upgrade/4-5","permalink":"/docs/upgrade/4-5","draft":false,"unlisted":false,"editUrl":"https://github.com/middyjs/middy/tree/main/website/docs/upgrade/4-5.md","tags":[],"version":"current","lastUpdatedAt":1750110598000,"sidebarPosition":9,"frontMatter":{"title":"Upgrade 4.x -> 5.x","sidebar_position":9},"sidebar":"tutorialSidebar","previous":{"title":"Upgrade 5.x -> 6.x","permalink":"/docs/upgrade/5-6"},"next":{"title":"Upgrade 3.x -> 4.x","permalink":"/docs/upgrade/3-4"}}');var d=n(4848),i=n(8453);const t={title:"Upgrade 4.x -> 5.x",sidebar_position:9},l=void 0,o={},a=[{value:"Notable changes",id:"notable-changes",level:2},{value:"Why we deprecated CJS",id:"why-we-deprecated-cjs",level:2},{value:"Core",id:"core",level:2},{value:"Util",id:"util",level:2},{value:"Middleware",id:"middleware",level:2},{value:"appconfig",id:"appconfig",level:2},{value:"cloudwatch-metrics",id:"cloudwatch-metrics",level:3},{value:"do-not-wait-for-empty-event-loop",id:"do-not-wait-for-empty-event-loop",level:3},{value:"error-logger",id:"error-logger",level:3},{value:"event-normalizer",id:"event-normalizer",level:3},{value:"http-content-encoding",id:"http-content-encoding",level:3},{value:"http-content-negotiation",id:"http-content-negotiation",level:3},{value:"http-cors",id:"http-cors",level:3},{value:"http-error-handler",id:"http-error-handler",level:3},{value:"http-event-normalizer",id:"http-event-normalizer",level:3},{value:"http-header-normalizer",id:"http-header-normalizer",level:3},{value:"http-json-body-parser",id:"http-json-body-parser",level:3},{value:"http-multipart-body-parser",id:"http-multipart-body-parser",level:3},{value:"http-partial-response",id:"http-partial-response",level:3},{value:"http-response-serializer",id:"http-response-serializer",level:3},{value:"http-router",id:"http-router",level:3},{value:"http-security-headers",id:"http-security-headers",level:3},{value:"http-urlencode-body-parser",id:"http-urlencode-body-parser",level:3},{value:"http-urlencode-path-parser",id:"http-urlencode-path-parser",level:3},{value:"input-output-logger",id:"input-output-logger",level:3},{value:"rds-signer",id:"rds-signer",level:3},{value:"s3-object-response",id:"s3-object-response",level:3},{value:"secrets-manager",id:"secrets-manager",level:3},{value:"service-discovery",id:"service-discovery",level:3},{value:"sqs-partial-batch-failure",id:"sqs-partial-batch-failure",level:3},{value:"ssm",id:"ssm",level:3},{value:"sts",id:"sts",level:3},{value:"validator",id:"validator",level:3},{value:"warmup",id:"warmup",level:3},{value:"ws-json-body-parser",id:"ws-json-body-parser",level:3},{value:"ws-response",id:"ws-response",level:3},{value:"ws-router",id:"ws-router",level:3},{value:"Notes",id:"notes",level:2}];function c(e){const r={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(r.p,{children:'aka "The ESM Only Update"'}),"\n",(0,d.jsx)(r.p,{children:"Version 5.x of Middy no longer supports Node.js versions 16.x. You are highly encouraged to move to Node.js 20.x."}),"\n",(0,d.jsx)(r.h2,{id:"notable-changes",children:"Notable changes"}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsx)(r.li,{children:"Middy no longer support Common JS modules."}),"\n",(0,d.jsx)(r.li,{children:"Update to use TypeScript v5 along with a refactor to most packages"}),"\n",(0,d.jsxs)(r.li,{children:["Update all errors to be consistent ",(0,d.jsx)(r.code,{children:"new Error('message', { cause: { package:'@middy/***', data:*** } })"})]}),"\n",(0,d.jsxs)(r.li,{children:["If using multiple ",(0,d.jsx)(r.code,{children:"http-*-body-parsers"})," on the same endpoint you'll need to set ",(0,d.jsx)(r.code,{children:"disableContentTypeError:true"})]}),"\n"]}),"\n",(0,d.jsx)(r.h2,{id:"why-we-deprecated-cjs",children:"Why we deprecated CJS"}),"\n",(0,d.jsxs)(r.ol,{children:["\n",(0,d.jsx)(r.li,{children:"ESM has been well supported in Lambda for almost 2 years now"}),"\n",(0,d.jsxs)(r.li,{children:["ESM is almost 2x faster than CJS at p95 ",(0,d.jsx)(r.a,{href:"https://aws.amazon.com/blogs/compute/using-node-js-es-modules-and-top-level-await-in-aws-lambda/",children:"Using Node.js ES modules and top-level await in AWS Lambda"})]}),"\n",(0,d.jsx)(r.li,{children:"Maintainability; Maintaining a package to work with every transpilers and build tools that are constantly changing over time is hard and time consuming."}),"\n"]}),"\n",(0,d.jsx)(r.p,{children:"If you're not able to upgrade your codebase to using ESM yet, that's okay, v4.x is super stable and support CJS."}),"\n",(0,d.jsx)(r.h2,{id:"core",children:"Core"}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsxs)(r.li,{children:["Updated ",(0,d.jsx)(r.code,{children:"plugin.timeoutEarlyResponse(...)"})," to throw new error with name ",(0,d.jsx)(r.code,{children:"TimeoutError"})," to match new ",(0,d.jsx)(r.code,{children:"AbortSignal.timeout()"}),"."]}),"\n"]}),"\n",(0,d.jsx)(r.h2,{id:"util",children:"Util"}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h2,{id:"middleware",children:"Middleware"}),"\n",(0,d.jsx)(r.h2,{id:"appconfig",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/appconfig",children:"appconfig"})}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsxs)(r.li,{children:["Update SDK to use newer ",(0,d.jsx)(r.code,{children:"appconfigdata"})," client ",(0,d.jsx)(r.strong,{children:"Breaking Change"})]}),"\n"]}),"\n",(0,d.jsx)(r.h3,{id:"cloudwatch-metrics",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/cloudwatch-metrics",children:"cloudwatch-metrics"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h3,{id:"do-not-wait-for-empty-event-loop",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/do-not-wait-for-empty-event-loop",children:"do-not-wait-for-empty-event-loop"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h3,{id:"error-logger",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/error-logger",children:"error-logger"})}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsxs)(r.li,{children:["Change ",(0,d.jsx)(r.code,{children:"logger"})," to have ",(0,d.jsx)(r.code,{children:"request"})," passed in instead of ",(0,d.jsx)(r.code,{children:"request.error"})," by default to allow access ",(0,d.jsx)(r.code,{children:"request.context"})," and ",(0,d.jsx)(r.code,{children:"request.event"})," ",(0,d.jsx)(r.strong,{children:"Breaking Change"})]}),"\n"]}),"\n",(0,d.jsx)(r.h3,{id:"event-normalizer",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/event-normalizer",children:"event-normalizer"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h3,{id:"http-content-encoding",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/http-content-encoding",children:"http-content-encoding"})}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsxs)(r.li,{children:["Use ",(0,d.jsx)(r.code,{children:"preferredLanguage"})," from ",(0,d.jsx)(r.code,{children:"context"})," instead of ",(0,d.jsx)(r.code,{children:"event"})," (See http-content-negotiation). ",(0,d.jsx)(r.strong,{children:"Breaking Change"})]}),"\n"]}),"\n",(0,d.jsx)(r.h3,{id:"http-content-negotiation",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/http-content-negotiation",children:"http-content-negotiation"})}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsxs)(r.li,{children:["Moved ",(0,d.jsx)(r.code,{children:"preferred*"})," from ",(0,d.jsx)(r.code,{children:"event"})," to ",(0,d.jsx)(r.code,{children:"context"})," ",(0,d.jsx)(r.strong,{children:"Breaking Change"})]}),"\n"]}),"\n",(0,d.jsx)(r.h3,{id:"http-cors",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/http-cors",children:"http-cors"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h3,{id:"http-error-handler",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/http-error-handler",children:"http-error-handler"})}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsxs)(r.li,{children:["Will return ",(0,d.jsx)(r.code,{children:"500"})," for all unhandled errors thrown ",(0,d.jsx)(r.strong,{children:"Breaking Change"})]}),"\n"]}),"\n",(0,d.jsx)(r.h3,{id:"http-event-normalizer",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/http-event-normalizer",children:"http-event-normalizer"})}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsxs)(r.li,{children:["Will no longer throw an error when HTTP type can't be determined ",(0,d.jsx)(r.strong,{children:"Breaking Change"})]}),"\n"]}),"\n",(0,d.jsx)(r.h3,{id:"http-header-normalizer",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/http-header-normalizer",children:"http-header-normalizer"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h3,{id:"http-json-body-parser",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/http-json-body-parser",children:"http-json-body-parser"})}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsxs)(r.li,{children:["Change ",(0,d.jsx)(r.code,{children:"disableContentTypeError"})," to ",(0,d.jsx)(r.code,{children:"false"})," by default ",(0,d.jsx)(r.strong,{children:"Breaking Change"})]}),"\n"]}),"\n",(0,d.jsx)(r.h3,{id:"http-multipart-body-parser",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/http-multipart-body-parser",children:"http-multipart-body-parser"})}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsxs)(r.li,{children:["Change ",(0,d.jsx)(r.code,{children:"disableContentTypeError"})," to ",(0,d.jsx)(r.code,{children:"false"})," by default ",(0,d.jsx)(r.strong,{children:"Breaking Change"})]}),"\n"]}),"\n",(0,d.jsx)(r.h3,{id:"http-partial-response",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/http-partial-response",children:"http-partial-response"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h3,{id:"http-response-serializer",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/http-response-serializer",children:"http-response-serializer"})}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsxs)(r.li,{children:["Removed parsing of ",(0,d.jsx)(r.code,{children:"Accept"})," header in favour of using ",(0,d.jsx)(r.code,{children:"@middy/http-content-negotiation"})," ",(0,d.jsx)(r.strong,{children:"Breaking Change"})]}),"\n"]}),"\n",(0,d.jsx)(r.h3,{id:"http-router",children:(0,d.jsx)(r.a,{href:"/docs/routers/http-router",children:"http-router"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h3,{id:"http-security-headers",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/http-security-headers",children:"http-security-headers"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h3,{id:"http-urlencode-body-parser",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/http-urlencode-body-parser",children:"http-urlencode-body-parser"})}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsxs)(r.li,{children:["Change ",(0,d.jsx)(r.code,{children:"disableContentTypeError"})," to ",(0,d.jsx)(r.code,{children:"false"})," by default ",(0,d.jsx)(r.strong,{children:"Breaking Change"})]}),"\n"]}),"\n",(0,d.jsx)(r.h3,{id:"http-urlencode-path-parser",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/http-urlencode-path-parser",children:"http-urlencode-path-parser"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h3,{id:"input-output-logger",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/input-output-logger",children:"input-output-logger"})}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsxs)(r.li,{children:["Updated to use ",(0,d.jsx)(r.code,{children:"structuredClone"})]}),"\n"]}),"\n",(0,d.jsx)(r.h3,{id:"rds-signer",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/rds-signer",children:"rds-signer"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h3,{id:"s3-object-response",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/s3-object-response",children:"s3-object-response"})}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsxs)(r.li,{children:["Refactored to use ",(0,d.jsx)(r.code,{children:"fetch"})," over ",(0,d.jsx)(r.code,{children:"https"}),". ",(0,d.jsx)(r.code,{children:"context"})," now returns ",(0,d.jsx)(r.code,{children:"s3ObjectFetch"})," to allow more control over how it's used. ",(0,d.jsx)(r.strong,{children:"Breaking Change"})]}),"\n"]}),"\n",(0,d.jsx)(r.h3,{id:"secrets-manager",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/secrets-manager",children:"secrets-manager"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h3,{id:"service-discovery",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/service-discovery",children:"service-discovery"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h3,{id:"sqs-partial-batch-failure",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/sqs-partial-batch-failure",children:"sqs-partial-batch-failure"})}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsxs)(r.li,{children:["Will now catch unhandled errors and set all messages to failed, preventing infinite loops ",(0,d.jsx)(r.strong,{children:"Breaking Change"})]}),"\n"]}),"\n",(0,d.jsx)(r.h3,{id:"ssm",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/ssm",children:"ssm"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h3,{id:"sts",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/sts",children:"sts"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h3,{id:"validator",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/validator",children:"validator"})}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsxs)(r.li,{children:["Use ",(0,d.jsx)(r.code,{children:"preferredLanguage"})," from ",(0,d.jsx)(r.code,{children:"context"})," instead of ",(0,d.jsx)(r.code,{children:"event"})," (See http-content-negotiation)."]}),"\n",(0,d.jsxs)(r.li,{children:[(0,d.jsx)(r.code,{children:"ajv-cmd"})," is no longer a required dependency, if you're pre-transpiling you'll need to run ",(0,d.jsx)(r.code,{children:"npm i ajv-cmd"}),"."]}),"\n"]}),"\n",(0,d.jsx)(r.h3,{id:"warmup",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/warmup",children:"warmup"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h3,{id:"ws-json-body-parser",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/ws-json-body-parser",children:"ws-json-body-parser"})}),"\n",(0,d.jsxs)(r.ul,{children:["\n",(0,d.jsxs)(r.li,{children:["Remove inclusion of ",(0,d.jsx)(r.code,{children:"rawBody"})," from event ",(0,d.jsx)(r.strong,{children:"Breaking Change"})]}),"\n"]}),"\n",(0,d.jsx)(r.h3,{id:"ws-response",children:(0,d.jsx)(r.a,{href:"/docs/middlewares/ws-response",children:"ws-response"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h3,{id:"ws-router",children:(0,d.jsx)(r.a,{href:"/docs/routers/ws-router",children:"ws-router"})}),"\n",(0,d.jsx)(r.p,{children:"No change"}),"\n",(0,d.jsx)(r.h2,{id:"notes",children:"Notes"}),"\n",(0,d.jsx)(r.p,{children:"None"})]})}function h(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,d.jsx)(r,{...e,children:(0,d.jsx)(c,{...e})}):c(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>t,x:()=>l});var s=n(6540);const d={},i=s.createContext(d);function t(e){const r=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:t(e.components),s.createElement(i.Provider,{value:r},e.children)}}}]);