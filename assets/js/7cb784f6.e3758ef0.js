"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[711],{3905:function(e,t,r){r.d(t,{Zo:function(){return p},kt:function(){return h}});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var d=n.createContext({}),s=function(e){var t=n.useContext(d),r=t;return e&&(r="function"==typeof e?e(t):l(l({},t),e)),r},p=function(e){var t=s(e.components);return n.createElement(d.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,o=e.originalType,d=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),c=s(r),h=a,m=c["".concat(d,".").concat(h)]||c[h]||u[h]||o;return r?n.createElement(m,l(l({ref:t},p),{},{components:r})):n.createElement(m,l({ref:t},p))}));function h(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=r.length,l=new Array(o);l[0]=c;var i={};for(var d in t)hasOwnProperty.call(t,d)&&(i[d]=t[d]);i.originalType=e,i.mdxType="string"==typeof e?e:a,l[1]=i;for(var s=2;s<o;s++)l[s]=r[s];return n.createElement.apply(null,l)}return n.createElement.apply(null,r)}c.displayName="MDXCreateElement"},7124:function(e,t,r){r.r(t),r.d(t,{frontMatter:function(){return i},contentTitle:function(){return d},metadata:function(){return s},toc:function(){return p},default:function(){return c}});var n=r(7462),a=r(3366),o=(r(7294),r(3905)),l=["components"],i={title:"Upgrade 1.x -> 2.x",sidebar_position:1e3},d=void 0,s={unversionedId:"upgrade/1-2",id:"upgrade/1-2",title:"Upgrade 1.x -> 2.x",description:"Version 2.x of Middy no longer supports Node.js versions 10.x. You are highly encouraged to move to Node.js 14.x,",source:"@site/docs/upgrade/1-2.md",sourceDirName:"upgrade",slug:"/upgrade/1-2",permalink:"/docs/upgrade/1-2",editUrl:"https://github.com/middyjs/middy/tree/main/website/docs/upgrade/1-2.md",tags:[],version:"current",lastUpdatedAt:1653075266,formattedLastUpdatedAt:"5/20/2022",sidebarPosition:1e3,frontMatter:{title:"Upgrade 1.x -> 2.x",sidebar_position:1e3},sidebar:"tutorialSidebar",previous:{title:"Upgrade 2.x -> 3.x",permalink:"/docs/upgrade/2-3"},next:{title:"Upgrade 0.x -> 1.x",permalink:"/docs/upgrade/0-1"}},p=[{value:"Core",id:"core",children:[],level:2},{value:"Middleware",id:"middleware",children:[{value:"cache",id:"cache",children:[],level:3},{value:"db-manager",id:"db-manager",children:[],level:3},{value:"do-not-wait-for-empty-event-loop",id:"do-not-wait-for-empty-event-loop",children:[],level:3},{value:"function-shield",id:"function-shield",children:[],level:3},{value:"http-content-negotiation",id:"http-content-negotiation",children:[],level:3},{value:"http-cors",id:"http-cors",children:[],level:3},{value:"http-error-handler",id:"http-error-handler",children:[],level:3},{value:"http-event-normalizer",id:"http-event-normalizer",children:[],level:3},{value:"http-header-normalizer",id:"http-header-normalizer",children:[],level:3},{value:"http-json-body-parser",id:"http-json-body-parser",children:[],level:3},{value:"http-multipart-body-parser",id:"http-multipart-body-parser",children:[],level:3},{value:"http-partial-response",id:"http-partial-response",children:[],level:3},{value:"http-response-serializer",id:"http-response-serializer",children:[],level:3},{value:"http-security-headers",id:"http-security-headers",children:[],level:3},{value:"http-urlencode-body-parser",id:"http-urlencode-body-parser",children:[],level:3},{value:"http-urlencode-path-parser",id:"http-urlencode-path-parser",children:[],level:3},{value:"input-output-logger",id:"input-output-logger",children:[],level:3},{value:"rds-signer",id:"rds-signer",children:[],level:3},{value:"s3-key-normalizer",id:"s3-key-normalizer",children:[],level:3},{value:"s3-object-response",id:"s3-object-response",children:[],level:3},{value:"secrets-manager",id:"secrets-manager",children:[],level:3},{value:"sqs-json-body-parser",id:"sqs-json-body-parser",children:[],level:3},{value:"sqs-partial-batch-failure",id:"sqs-partial-batch-failure",children:[],level:3},{value:"ssm",id:"ssm",children:[],level:3},{value:"sts",id:"sts",children:[],level:3},{value:"validator",id:"validator",children:[],level:3},{value:"warmup",id:"warmup",children:[],level:3}],level:2}],u={toc:p};function c(e){var t=e.components,r=(0,a.Z)(e,l);return(0,o.kt)("wrapper",(0,n.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Version 2.x of Middy no longer supports Node.js versions 10.x. You are highly encouraged to move to Node.js 14.x,\nwhich support ES6 modules by default (",(0,o.kt)("inlineCode",{parentName:"p"},"export"),"), optional chaining (",(0,o.kt)("inlineCode",{parentName:"p"},"?."),") and nullish coalescing operator (",(0,o.kt)("inlineCode",{parentName:"p"},"??"),") natively."),(0,o.kt)("h2",{id:"core"},"Core"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"In handler ",(0,o.kt)("inlineCode",{parentName:"li"},"callback(err, reponse)")," have been removed for ",(0,o.kt)("inlineCode",{parentName:"li"},"async/await")," support",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"return response")," to trigger ",(0,o.kt)("inlineCode",{parentName:"li"},"after")," middleware stack"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"throw new Error(...)")," to trigger ",(0,o.kt)("inlineCode",{parentName:"li"},"onError")," middleware stack"))),(0,o.kt)("li",{parentName:"ul"},"In middleware ",(0,o.kt)("inlineCode",{parentName:"li"},"next(err)")," has been removed for ",(0,o.kt)("inlineCode",{parentName:"li"},"async/await")," support",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"throw new Error(...)")," to trigger ",(0,o.kt)("inlineCode",{parentName:"li"},"onError")," middleware stack"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"return reponse")," to ",(0,o.kt)("strong",{parentName:"li"},"short circuit")," any middleware stack and respond. v1.x currently throws an error when something is returned")))),(0,o.kt)("h2",{id:"middleware"},"Middleware"),(0,o.kt)("h3",{id:"cache"},"cache"),(0,o.kt)("p",null,"Deprecated. Too generic and had low usage."),(0,o.kt)("p",null,"However, you can use the following if needed:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const { createHash } = require('crypto')\n\nmodule.exports = (opts) => {\n  const storage = {}\n  const defaults = {\n    calculateCacheId: async (event) => createHash('md5').update(JSON.stringify(event)).digest('hex'),\n    getValue: async (key) => storage[key],\n    setValue: async (key, value) => {\n      storage[key] = value\n    }\n  }\n\n  const options = { ...defaults, ...opts }\n  let currentCacheKey\n\n  const cacheMiddlewareBefore = async (request) => {\n    const cacheKey = await options.calculateCacheId(request.event)\n    const response = await options.getValue(cacheKey)\n    if (response) {\n      return response\n    }\n    request.internal.cacheKey = cacheKey\n  }\n\n  const cacheMiddlewareAfter = async (request) => {\n    await options.setValue(request.internal.cacheKey, request.response)\n  }\n  \n  return {\n    before: cacheMiddlewareBefore,\n    after: cacheMiddlewareAfter\n  }\n}\n")),(0,o.kt)("h3",{id:"db-manager"},"db-manager"),(0,o.kt)("p",null,"Deprecated. Too generic and had low usage. You can check out ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/willfarrell/middy-rds"},"middy-rds")," as a\npossible alternative or example on building your own replacement."),(0,o.kt)("h3",{id:"do-not-wait-for-empty-event-loop"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/do-not-wait-for-empty-event-loop"},"do-not-wait-for-empty-event-loop")),(0,o.kt)("p",null,"No change"),(0,o.kt)("h3",{id:"function-shield"},"function-shield"),(0,o.kt)("p",null,"Deprecated. Only supported up to Node v10."),(0,o.kt)("h3",{id:"http-content-negotiation"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/http-content-negotiation"},"http-content-negotiation")),(0,o.kt)("p",null,"No change"),(0,o.kt)("h3",{id:"http-cors"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/http-cors"},"http-cors")),(0,o.kt)("p",null,"Added new options to support more headers"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"methods"),(0,o.kt)("li",{parentName:"ul"},"exposeHeaders"),(0,o.kt)("li",{parentName:"ul"},"requestHeaders"),(0,o.kt)("li",{parentName:"ul"},"requestMethods")),(0,o.kt)("h3",{id:"http-error-handler"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/http-error-handler"},"http-error-handler")),(0,o.kt)("p",null,"Added in support to honour httpError.expose. Errors with statusCode >= 500 are no longer applied to response by default.\nAdded new option to catch any non-http and statusCode >= 500 errors"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"fallbackMessage")),(0,o.kt)("h3",{id:"http-event-normalizer"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/http-event-normalizer"},"http-event-normalizer")),(0,o.kt)("p",null,"No change"),(0,o.kt)("h3",{id:"http-header-normalizer"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/http-header-normalizer"},"http-header-normalizer")),(0,o.kt)("p",null,"No change"),(0,o.kt)("h3",{id:"http-json-body-parser"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/http-json-body-parser"},"http-json-body-parser")),(0,o.kt)("p",null,"No change"),(0,o.kt)("h3",{id:"http-multipart-body-parser"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/http-multipart-body-parser"},"http-multipart-body-parser")),(0,o.kt)("p",null,"No change"),(0,o.kt)("h3",{id:"http-partial-response"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/http-partial-response"},"http-partial-response")),(0,o.kt)("p",null,"No change"),(0,o.kt)("h3",{id:"http-response-serializer"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/http-response-serializer"},"http-response-serializer")),(0,o.kt)("p",null,"No change"),(0,o.kt)("h3",{id:"http-security-headers"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/http-security-headers"},"http-security-headers")),(0,o.kt)("p",null,"No longer adds ",(0,o.kt)("inlineCode",{parentName:"p"},"statusCode:500")," when there is no response."),(0,o.kt)("h3",{id:"http-urlencode-body-parser"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/http-urlencode-body-parser"},"http-urlencode-body-parser")),(0,o.kt)("p",null,"Remove ",(0,o.kt)("inlineCode",{parentName:"p"},"extended")," option. Only uses ",(0,o.kt)("inlineCode",{parentName:"p"},"qs")," as the parser, formally enabled by options ",(0,o.kt)("inlineCode",{parentName:"p"},"{extended: true}"),"."),(0,o.kt)("h3",{id:"http-urlencode-path-parser"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/http-urlencode-path-parser"},"http-urlencode-path-parser")),(0,o.kt)("p",null,"No change"),(0,o.kt)("h3",{id:"input-output-logger"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/input-output-logger"},"input-output-logger")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Now additionally logs response from the ",(0,o.kt)("inlineCode",{parentName:"li"},"onError")," middleware stack"),(0,o.kt)("li",{parentName:"ul"},"Support for omiting within nested arrays"),(0,o.kt)("li",{parentName:"ul"},"Add in support for ",(0,o.kt)("inlineCode",{parentName:"li"},"replacer")," to be passed into ",(0,o.kt)("inlineCode",{parentName:"li"},"JSON.stringify()"))),(0,o.kt)("h3",{id:"rds-signer"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/rds-signer"},"rds-signer")),(0,o.kt)("p",null,"New middleware to fetch RDS credential used when connecting with IAM roles. This was built into ",(0,o.kt)("inlineCode",{parentName:"p"},"db-manager"),"."),(0,o.kt)("h3",{id:"s3-key-normalizer"},"s3-key-normalizer"),(0,o.kt)("p",null,"No change"),(0,o.kt)("h3",{id:"s3-object-response"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/s3-object-response"},"s3-object-response")),(0,o.kt)("p",null,"New middleware to fetch and respond to S3 Object Get request event."),(0,o.kt)("h3",{id:"secrets-manager"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/secrets-manager"},"secrets-manager")),(0,o.kt)("p",null,"Refactored, see documentation"),(0,o.kt)("h3",{id:"sqs-json-body-parser"},"sqs-json-body-parser"),(0,o.kt)("p",null,"No change"),(0,o.kt)("h3",{id:"sqs-partial-batch-failure"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/sqs-partial-batch-failure"},"sqs-partial-batch-failure")),(0,o.kt)("p",null,"Replaced option ",(0,o.kt)("inlineCode",{parentName:"p"},"sqs")," with ",(0,o.kt)("inlineCode",{parentName:"p"},"AwsClient")," and added in more options for control."),(0,o.kt)("h3",{id:"ssm"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/ssm"},"ssm")),(0,o.kt)("p",null,"Refactored, see documentation"),(0,o.kt)("h3",{id:"sts"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/sts"},"sts")),(0,o.kt)("p",null,"New middleware to fetch assume role credentials."),(0,o.kt)("h3",{id:"validator"},(0,o.kt)("a",{parentName:"h3",href:"/docs/middlewares/validator"},"validator")),(0,o.kt)("p",null,"Upgraded ",(0,o.kt)("inlineCode",{parentName:"p"},"ajv")," and it's plugins to support JSON Schema Draft 2020-12 specification. Defaults were change because of this."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Plugin ",(0,o.kt)("inlineCode",{parentName:"li"},"ajv-keywords")," removed from being included by default because it's quite a large package and usually only one keyword is used."),(0,o.kt)("li",{parentName:"ul"},"Plugin ",(0,o.kt)("inlineCode",{parentName:"li"},"ajv-errors")," removed from included by default because it conflicts with ",(0,o.kt)("inlineCode",{parentName:"li"},"ajv-i18n")," when dealing with custom messages for multiple languages")),(0,o.kt)("h3",{id:"warmup"},"warmup"),(0,o.kt)("p",null,"Deprecated. This was a work round for a missing feature in AWS Lambda. AWS added in the ability to use ",(0,o.kt)("a",{parentName:"p",href:"https://aws.amazon.com/blogs/aws/new-provisioned-concurrency-for-lambda-functions/"},"provisioned concurrency"),"\non 2019-12-03, removing the need for this work around."),(0,o.kt)("p",null,"However, you can use the following if needed:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"middy(lambdaHandler)\n  .before((request) => {\n    if (request.event.source === 'serverless-plugin-warmup') {\n      console.log('Exiting early via warmup Middleware')\n      return 'warmup'\n    }\n  })\n")))}c.isMDXComponent=!0}}]);