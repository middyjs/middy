"use strict";(self.webpackChunkmiddy=self.webpackChunkmiddy||[]).push([[1570],{1964:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>m,frontMatter:()=>r,metadata:()=>i,toc:()=>l});var a=t(5893),o=t(1151);const r={title:"Streamify Response",position:5},s=void 0,i={id:"intro/streamify-response",title:"Streamify Response",description:"Middy also supports streamed responses.",source:"@site/docs/intro/06-streamify-response.md",sourceDirName:"intro",slug:"/intro/streamify-response",permalink:"/docs/intro/streamify-response",draft:!1,unlisted:!1,editUrl:"https://github.com/middyjs/middy/tree/main/website/docs/intro/06-streamify-response.md",tags:[],version:"current",lastUpdatedAt:1713583237,formattedLastUpdatedAt:"Apr 20, 2024",sidebarPosition:6,frontMatter:{title:"Streamify Response",position:5},sidebar:"tutorialSidebar",previous:{title:"Handling Errors",permalink:"/docs/intro/handling-errors"},next:{title:"Testing",permalink:"/docs/intro/testing"}},d={},l=[{value:"Lambda Function URL Example",id:"lambda-function-url-example",level:2},{value:"Lambda InvokeWithResponseStream Example",id:"lambda-invokewithresponsestream-example",level:2},{value:"Requesting Lambda",id:"requesting-lambda",level:3}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"Middy also supports streamed responses."}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsxs)(n.p,{children:["You can progressively stream response payloads through Lambda function URLs, including as an Amazon CloudFront origin, along with using the AWS SDK or using Lambda\u2019s invoke API. You can not use Amazon API Gateway and Application Load Balancer to progressively stream response payloads, but you can use the functionality to return larger payloads. (",(0,a.jsx)(n.a,{href:"https://aws.amazon.com/blogs/compute/introducing-aws-lambda-response-streaming/",children:"https://aws.amazon.com/blogs/compute/introducing-aws-lambda-response-streaming/"}),")"]}),"\n"]}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["Set ",(0,a.jsx)(n.code,{children:"streamifyResponse: true"})," into middy options"]}),"\n",(0,a.jsx)(n.li,{children:"a. For HTTP Events return using an HTTP event response with the body as a string or ReadableStream.\nb. For InvokeWithResponseStream Events return a response with a string or ReadableStream."}),"\n"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["API Gateway: If you're getting a ",(0,a.jsx)(n.code,{children:"500"})," status code. Be sure to set your integration to ",(0,a.jsx)(n.code,{children:"HTTP_PROXY"})," over ",(0,a.jsx)(n.code,{children:"LAMBDA_PROXY"})," and enable Function URL on the lambda."]}),"\n",(0,a.jsxs)(n.li,{children:["Function URLs: If receiving no content and non-200 status code are being converted to ",(0,a.jsx)(n.code,{children:"200"}),". Be sure to set ",(0,a.jsx)(n.code,{children:"Invoke Mode"})," to ",(0,a.jsx)(n.code,{children:"RESPONSE_STREAM"})," over ",(0,a.jsx)(n.code,{children:"BUFFERED"}),"."]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"lambda-function-url-example",children:"Lambda Function URL Example"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import middy from '@middy/core'\nimport { createReadableStream } from '@datastream/core'\n\nconst lambdaHandler = (event, context) => {\n  return {\n    statusCode: 200,\n    headers: {\n      'Content-Type': 'text/csv'\n    },\n    body: createReadableStream('...') // or string\n  }\n}\n\nexport const handler = middy({ streamifyResponse: true }).handler(lambdaHandler)\n"})}),"\n",(0,a.jsx)(n.h2,{id:"lambda-invokewithresponsestream-example",children:"Lambda InvokeWithResponseStream Example"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import middy from '@middy/core'\nimport { createReadableStream } from '@datastream/core'\n\nconst lambdaHandler = (event, context) => {\n  return createReadableStream('...') // or string\n}\nexport const handler = middy({ streamifyResponse: true }).handler(lambdaHandler)\n"})}),"\n",(0,a.jsx)(n.h3,{id:"requesting-lambda",children:"Requesting Lambda"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import {\n  LambdaClient,\n  InvokeWithResponseStreamCommand\n} from '@aws-sdk/client-lambda'\n\nconst lambda = new LambdaClient()\n\nconst res = await lambda.send(\n  new InvokeWithResponseStreamCommand({\n    FunctionName: 'function-name',\n    Payload: JSON.stringify({...})\n  })\n)\n\nconst decoder = new TextDecoder('utf-8')\nlet body = ''\nfor await (const chunk of res.EventStream) {\n  if (chunk?.PayloadChunk?.Payload) {\n    body += decoder.decode(Buffer.from(chunk.PayloadChunk.Payload))\n  }\n}\n"})})]})}function m(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>i,a:()=>s});var a=t(7294);const o={},r=a.createContext(o);function s(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);